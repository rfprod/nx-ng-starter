# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: publish-packages

on:
  repository_dispatch:
    types: [publish_packages]
  workflow_call:
    inputs:
      dry-run:
        description: Used by premerge workflow to confirm the ability to publish packages without doing so
        type: string
        required: false
        default: 'false'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode'
        required: false
        default: 'false'
        type: string

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.event.client_payload.ref || github.ref_name || github.ref }}.${{ github.sha }}.publish-packages
  cancel-in-progress: true

jobs:
  checks:
    runs-on: ubuntu-latest

    outputs:
      changes: ${{ steps.check-changes.outputs.changes }}
      origin: ${{ steps.check-origin.outputs.origin }}
      dry-run: ${{ steps.variables.outputs.dry-run }}
      ref: ${{ steps.variables.outputs.ref }}

    steps:
      - name: Variables
        id: variables
        env:
          DRY_RUN: >-
            ${{
              (github.event_name == 'repository_dispatch' && (github.event.client_payload.dry_run == true || github.event.client_payload.dry_run == 'true')) ||
              (github.event_name == 'workflow_dispatch' && (inputs.dry-run == true || inputs.dry-run == 'true')) ||
              (github.event_name == 'workflow_call' && inputs.dry-run) ||
              false
            }}
          REF: >-
            ${{
              (github.event_name == 'repository_dispatch' && github.event.client_payload.ref) ||
              (github.event_name == 'workflow_dispatch' && github.ref_name) ||
              (github.event_name == 'workflow_call' && github.ref_name) ||
              github.ref
            }}
        run: |
          echo "dry-run=$(echo ${DRY_RUN})" >> $GITHUB_OUTPUT
          echo "ref=$(echo ${REF})" >> $GITHUB_OUTPUT
          echo "### :rocket: Publish Packages" >> $GITHUB_STEP_SUMMARY
          echo "REF: ${REF}" >> $GITHUB_STEP_SUMMARY
          echo "DRY_RUN: ${DRY_RUN}" >> $GITHUB_STEP_SUMMARY

      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.variables.outputs.ref }}
          fetch-depth: 2

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Check changes
        id: check-changes
        uses: ./.github/actions/check-changes

      - name: Check origin
        id: check-origin
        uses: ./.github/actions/check-origin

  publish-client-d3-charts:
    needs: checks
    if: ${{ needs.checks.outputs.origin == 'true' && (needs.checks.outputs.dry-run == 'true' || fromJSON(needs.checks.outputs.changes).packageCharts == 'true') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.checks.outputs.ref }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: NPM publish
        uses: ./.github/actions/npm-publish
        with:
          library-name: client-d3-charts
          use-trusted-publishing: true
          dry-run: ${{ needs.checks.outputs.dry-run == 'true' }}

  publish-client-guided-tour:
    needs: checks
    if: ${{ needs.checks.outputs.origin == 'true' && (needs.checks.outputs.dry-run == 'true' || fromJSON(needs.checks.outputs.changes).packageGuidedTour == 'true') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.checks.outputs.ref }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: NPM publish
        uses: ./.github/actions/npm-publish
        with:
          library-name: client-guided-tour
          use-trusted-publishing: true
          dry-run: ${{ needs.checks.outputs.dry-run == 'true' }}

  publish-client-pwa-offline:
    needs: checks
    if: ${{ needs.checks.outputs.origin == 'true' && (needs.checks.outputs.dry-run == 'true' || fromJSON(needs.checks.outputs.changes).packagePwaOffline == 'true') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.checks.outputs.ref }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: NPM publish
        uses: ./.github/actions/npm-publish
        with:
          library-name: client-pwa-offline
          use-trusted-publishing: true
          dry-run: ${{ needs.checks.outputs.dry-run == 'true' }}

  publish-client-util-eliza:
    needs: checks
    if: ${{ needs.checks.outputs.origin == 'true' && (needs.checks.outputs.dry-run == 'true' || fromJSON(needs.checks.outputs.changes).packageEliza == 'true') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.checks.outputs.ref }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: NPM publish
        uses: ./.github/actions/npm-publish
        with:
          library-name: client-util-eliza
          use-trusted-publishing: true
          dry-run: ${{ needs.checks.outputs.dry-run == 'true' }}

  publish-backend-diagnostics:
    needs: checks
    if: ${{ needs.checks.outputs.origin == 'true' && (needs.checks.outputs.dry-run == 'true' || fromJSON(needs.checks.outputs.changes).packageBackendDiagnostics == 'true') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.checks.outputs.ref }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: NPM publish
        uses: ./.github/actions/npm-publish
        with:
          library-name: backend-diagnostics
          use-trusted-publishing: true
          dry-run: ${{ needs.checks.outputs.dry-run == 'true' }}
