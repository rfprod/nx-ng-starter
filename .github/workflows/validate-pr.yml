# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: validate-pr

on:
  pull_request:
    branches: [main]

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.ref }}.validate-pr
  cancel-in-progress: true

jobs:
  checks:
    runs-on: ubuntu-latest

    outputs:
      projects: ${{ steps.check-projects.outputs.projects }}
      projects-build: ${{ steps.check-projects-build.outputs.projects }}
      changes: ${{ steps.check-changes.outputs.changes }}
      success: ${{ steps.check.outputs.success || 'true' }}
      origin: ${{ steps.check-origin.outputs.origin }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Validate commit messages
        if: ${{ github.event.pull_request.user.login != 'dependabot[bot]' }}
        run: |
          git checkout -b premerge
          git fetch origin main:main
          npx --no-install commitlint --from main

      - name: Validation contribution size
        if: ${{ github.event.pull_request.user.login != 'dependabot[bot]' }}
        uses: ./.github/actions/validate-contribution-size

      - name: Check affected projects with target `build`
        id: check-projects-build
        uses: ./.github/actions/check-projects
        with:
          affected: 'true'
          batch-size: '3'
          with-target: 'build'

      - name: Check affected projects
        id: check-projects
        uses: ./.github/actions/check-projects
        with:
          affected: 'true'

      - name: Check changes
        id: check-changes
        uses: ./.github/actions/check-changes
        with:
          premerge: 'true'
          trunk: 'main'

      - name: Check origin
        id: check-origin
        uses: ./.github/actions/check-origin

      - name: Set failure
        id: check
        if: failure()
        run: echo "success=$(echo 'false')" >> $GITHUB_OUTPUT

  lint:
    needs: checks
    runs-on: ubuntu-latest

    outputs:
      success: ${{ steps.check.outputs.success || 'true' }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Lint shell
        if: fromJSON(needs.checks.outputs.changes).shelltools == 'true'
        run: |
          sudo apt install shellcheck
          npx nx run tools:lint-shell

      - name: Analyze circular dependencies
        if: fromJSON(needs.checks.outputs.changes).src == 'true'
        run: |
          sudo npm i -g madge@latest
          madge --circular --extensions ts ./apps ./libs ./tools --ts-config ./tsconfig.base.json

      - name: Set failure
        id: check
        if: failure()
        run: echo "success=$(echo 'false')" >> $GITHUB_OUTPUT

  lint-affected:
    needs: checks
    if: needs.checks.outputs.projects != '[]'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      max-parallel: 40
      matrix:
        projects: ${{ fromJSON(needs.checks.outputs.projects) }}

    outputs:
      success: ${{ steps.check.outputs.success || 'true' }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Lint ts
        run: npx nx run-many --target lint --projects ${{ matrix.projects }}

      - name: Lint html
        run: npx nx run-many --target prettier-check --dryRun --projects ${{ matrix.projects }}

      - name: Lint scss
        run: npx nx run-many --target stylelint-check --dryRun --projects ${{ matrix.projects }}

      - name: Set failure
        id: check
        if: failure()
        run: echo "success=$(echo 'false')" >> $GITHUB_OUTPUT

  test:
    needs: checks
    runs-on: ubuntu-latest

    outputs:
      success: ${{ steps.check.outputs.success || 'true' }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          compodoc: true

      - name: Documentation coverage
        run: npx nx run tools:compodoc-coverage-test

      - name: Set failure
        id: check
        if: failure()
        run: echo "success=(echo 'false')" >> $GITHUB_OUTPUT

  test-affected:
    needs: checks
    if: needs.checks.outputs.projects != '[]'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      max-parallel: 40
      matrix:
        projects: ${{ fromJSON(needs.checks.outputs.projects) }}

    outputs:
      success: ${{ steps.check.outputs.success || 'true' }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Compiler check
        run: npx nx run-many --target tsc-check --projects ${{ matrix.projects }}
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Unit test
        run: npx nx run-many --target test --projects ${{ matrix.projects }} --silent --no-file-parallelism --maxWorkers 1 --maxConcurrency 1
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Set failure
        id: check
        if: failure()
        run: echo "success=(echo 'false')" >> $GITHUB_OUTPUT

  build:
    needs: checks
    runs-on: ubuntu-latest

    outputs:
      success: ${{ steps.check.outputs.success || 'true' }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Set failure
        id: check
        if: failure()
        run: echo "success=(echo 'false')" >> $GITHUB_OUTPUT

  build-affected:
    needs: checks
    if: needs.checks.outputs.projects-build != '[]'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      max-parallel: 40
      matrix:
        projects: ${{ fromJSON(needs.checks.outputs.projects-build) }}

    outputs:
      success: ${{ steps.check.outputs.success || 'true' }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Build affected
        run: npx nx run-many --target build --projects ${{ matrix.projects }}

      - name: Set failure
        id: check
        if: failure()
        run: echo "success=(echo 'false')" >> $GITHUB_OUTPUT

  publish-packages-dry-run:
    needs: checks
    if: ${{ needs.checks.outputs.origin == 'true' && fromJSON(needs.checks.outputs.changes).packages == 'true' }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: write
      id-token: write

    outputs:
      publish_conclusion: ${{ steps.publish-trigger.outputs.publish_conclusion }}

    steps:
      - name: Publish Packages (dry run)
        id: publish-trigger
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.pull_request.head.ref }}
          EVENT_TYPE: publish_packages
          DRY_RUN: true
        run: |
          echo "### :rocket: Publish Packages (dry run)" >> $GITHUB_STEP_SUMMARY
          echo "BRANCH: ${BRANCH}" >> $GITHUB_STEP_SUMMARY
          echo "EVENT_TYPE: ${EVENT_TYPE}" >> $GITHUB_STEP_SUMMARY
          echo "DRY_RUN: ${DRY_RUN}" >> $GITHUB_STEP_SUMMARY

          gh api \
            -X POST \
            /repos/${REPO}/dispatches \
            --header 'Accept: application/vnd.github+json' \
            --input - <<EOF
          {
            "event_type": "${EVENT_TYPE}",
            "client_payload": {
              "ref": "${BRANCH}",
              "dry_run": "${DRY_RUN}",
              "premerge": "true"
            }
          }
          EOF

          echo "Looking for the workflow run..."
          # up to ~5 min (30 * 10 s)
          for i in {1..30}; do
            RUN_ID=$(
              gh api "/repos/${REPO}/actions/runs?event=repository_dispatch&per_page=20" \
                --jq '.workflow_runs
                  | map(
                      select(
                        .event == "repository_dispatch"
                        and .status != "completed" # optional: skip already-completed runs, or change logic
                        and (
                            (.display_title | test("'"${EVENT_TYPE}"'"; "i"))            # Optional: event_type in title
                            or (.name | test("'"${EVENT_TYPE}"'"; "i"))                  # Optional: event_type in name
                            or true # always true if you skip these, or include more logic as needed
                        )
                      )
                  )
                  | sort_by(.created_at)
                  | .[-1].id
                '
            )

            if [[ -n "$RUN_ID" ]]; then
              echo "Found RUN_ID: $RUN_ID"
              break
            fi
            sleep 10
          done

          if [[ -z "$RUN_ID" ]]; then
            echo "âŒ Could not locate the workflow run"
            exit 1
          fi

          echo "âœ… Found run ID $RUN_ID - waiting for completion..."

          while true; do
            STATUS=$(gh api "/repos/${REPO}/actions/runs/${RUN_ID}" --jq '.status')
            CONCL=$(gh api "/repos/${REPO}/actions/runs/${RUN_ID}" --jq '.conclusion')
            if [[ "$STATUS" == "completed" ]]; then
              echo "ðŸŸ¢ Run completed with conclusion: $CONCL"
              echo "publish_conclusion=$CONCL" >> $GITHUB_OUTPUT
              break
            fi
            echo "â³ Run still $STATUS â€¦ sleeping 10 s"
            sleep 10
          done

  premerge:
    needs: [checks, lint, lint-affected, test, test-affected, build, build-affected, publish-packages-dry-run]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Check result
        run: |
          if [[ "$CHECKS_RESULT" != "true" || \
            "$LINT_RESULT" != "true" || \
            "$LINT_AFFECTED_RESULT" != "true" || \
            "$TEST_RESULT" != "true" || \
            "$TEST_AFFECTED_RESULT" != "true" || \
            "$BUILD_RESULT" != "true" || \
            "$BUILD_AFFECTED_RESULT" != "true" || \
            "$PUBLISH_PACKAGES_DRY_RUN" != "true" \
          ]]; then exit 1; fi
          echo "### :rocket: Premerge checks succeeded" >> $GITHUB_STEP_SUMMARY
        env:
          CHECKS_RESULT: ${{ needs.checks.outputs.success }}
          LINT_RESULT: ${{ needs.lint.result == 'success' || needs.lint.result == 'skipped' }}
          LINT_AFFECTED_RESULT: ${{ needs.lint-affected.result == 'success' || needs.lint-affected.result == 'skipped' }}
          TEST_RESULT: ${{ needs.test.result == 'success' || needs.test.result == 'skipped' }}
          TEST_AFFECTED_RESULT: ${{ needs.test-affected.result == 'success' || needs.test-affected.result == 'skipped' }}
          BUILD_RESULT: ${{ needs.build.result == 'success' || needs.build.result == 'skipped' }}
          BUILD_AFFECTED_RESULT: ${{ needs.build-affected.result == 'success' || needs.build-affected.result == 'skipped' }}
          PUBLISH_PACKAGES_DRY_RUN: ${{ (needs.publish-packages-dry-run.result == 'success' && needs.publish-packages-dry-run.outputs.publish_conclusion == 'success') || needs.publish-packages-dry-run.result == 'skipped' }}
